#!/bin/bash

# a trusted header


# regtest snapshot
INIT_HEADERS='[0x00000020e67409b91dc4e16674550ee071f689fd0da9fb4883eea336b66d1c0a00000000adf51f9b2d8d42af7bd9c541609a0c12b30526c0e288255010791af3927a0eca1188bc67ffff001abb6cd52b,0x00000020b592d8b30b59b4a7535d8922f52b9aaaf69b330444a2f3503200000000000000c38bdc708fcc58d2ddf1c92115aacd8a297783f29f944f4ec485dd79b5271367c28cbc67ffff001da8613d2a,0x000000208440140f99bf9b2a7acce478e905db48c4e98112bc88834b008449030000000022bd0c7f0f7919f6b32f9867c77d5e22da5daf963d6361ff0c206d83b36deca9bf8cbc67ffff001a96d6702f,0x00e0ff377e04a1593d1bed86945282f57a9def98140dba2a22ee202979000000000000002a5a53f751a9e59141063f31b43f55663991c79365485db493ab4be2fce56ad4bf8cbc67ffff001a403cf654,0x0040a925a11852b3444c274831e4b6f414514aaa9d97e766a010829ca600000000000000f6a5c2d2332395bc09b1f0a8e529c34a146150910c3715cfdb01b65797d6af16c08cbc67ffff001a8ff29264,0x00004020fba26bb74095bae9c209e3164f031279f4167aac749ca4ff9a00000000000000c9693266b0020ca8333ac2b1fa5d4a2072f4113f8790109a69585d6099d3a071c08cbc67ffff001a87dca787,0x0000c020bb46404cba843a27165693ba36bbb8d9cf784f4287243553a6000000000000002355151971ec92227571d3562aecb7ce74bbc25816cfd052ea4e74ce485babfdc08cbc67ffff001ac656f217,0x0000c020b969f197327d74a673aec726cdeee0cfde958c1602c398808700000000000000b79cef8ba8b850c38992e365c9d16103541edd8ed607bc6768bbbe99859d38d9c18cbc67ffff001aa789f85a,0x00a036208e5184eaa101c9840ad303002a096e1eb88b88ead631e231eb000000000000000a5e133124d48ef6c3077f36fd369eb6056cbb77a6aafe03fc4e8f857fd82ff5c18cbc67ffff001adcf915a7,0x0000c02050a867dc9d7836963e2b5a5605fc35cf8a9a24d337d3e09bdc000000000000000158eef7d52909e967e8c4a88dab4717e7df2f1956f35dd3240f659302f143c4c18cbc67ffff001ac52328da,0x00c0c823ef186531d401bb32bbb1286023d67472a809e28b6d7a0d0b0200000000000000abe8783bf4a961dbfd317ef134c92e8a3b54fed71fd6e9c246cc038f895e55ccc18cbc67ffff001a61602d8d,0x00000021ca438d6011dd4a724ecce32e2b62b058167c4049c8277b91a400000000000000d6ac947f7bcc796e2558dbd6b00419c51ad6e2bbae5123c9b0ad345f74ffc256c18cbc67ffff001a25b6290f]'

# 0x00000030516567e505288fe41b2fc6be9b96318c406418c7d338168fe75a26111490eb2fec401c3902aa39842e53a0c641af518957ec3aa5984a44d32e2a9f7fee2fa67a3f5b6167ffff7f2004000000 = 201 bitcoin snapshot
# a list of header follow a init header
HEADERS_FOR_INSERT='[0x000000307306011c31d1f14a422c50c70cbedb1233757505cb887d82d51ae3f27e23062d6be46c161e69696c1c83ba3a1ea52f071fcdada5a6bce28f5da591b969b42da139c5b167ffff7f2000000000,0x00000030e98bb046cd25a629c91f0c7623cc2ed0c12ef6db5e41956536c261eb673d0b0f813b60988eadd1961289bf5f2098f6ca0c7dd35ae95e78807c6582a46e00107f39c5b167ffff7f2004000000,0x000000304f58550f49b5c9dce6328bc8d7b8f5941823efcc51741a024c17d9745ba21111cb2db51b4bf0858c2318820adafa1c8640703dca1faceea0205f388f160d452539c5b167ffff7f2004000000,0x00000030aa8bd6ce82edf1f9c03abc2243281f622594bc3aec5106a17f612371f76060084e05aaf29bda3424553cb4636006d006030690b91875fe96fdb4c52d4a38ba8a39c5b167ffff7f2003000000]'

# a list of header this create fork, and more powerful than current chain
HEADERS_FOR_FORK='[0x000000307306011c31d1f14a422c50c70cbedb1233757505cb887d82d51ae3f27e23062d6be46c161e69696c1c83ba3a1ea52f071fcdada5a6bce28f5da591b969b42da19dc5b167ffff7f2001000000,0x000000302ba076eb907ec3c060954d36dfcf0e735c815c9531f6d44667aa32f5999f412d813b60988eadd1961289bf5f2098f6ca0c7dd35ae95e78807c6582a46e00107f9dc5b167ffff7f2001000000,0x00000030525bda2756ff6f9e440c91590490462ac33e0fedb05b1558cfd3f7ce90920d16cb2db51b4bf0858c2318820adafa1c8640703dca1faceea0205f388f160d45259dc5b167ffff7f2002000000,0x000000306052592f4f0e4886a0eca2c1d154e8b9761e011b4f7b3a00908e2a830f7f6c6a4e05aaf29bda3424553cb4636006d006030690b91875fe96fdb4c52d4a38ba8a9dc5b167ffff7f2001000000,0x000000309c32ae8f3b099ea17563bb425476cf962b84269e09d17e19350b819695970f2cdebd5d70e4be4f6f5cc474416137a697f1fca22bf87e9066eb9b43dd7882d2329dc5b167ffff7f2001000000,0x000000307370f207ef4945a89b10b1c60a14770136109de093df4544340251190a5c2436494bba4bf2f3dc3a1d8c1bb592eeadc16c77b6bdd42c6ad2003a704641c3caeb9dc5b167ffff7f2000000000,0x000000305e52d670c3efd5ff9152b325f6cf2c59154b856215a99c8101efc51688937e734ca6a58af04afaa3eea3d8c6fa6c29eb0454a7e18d5953a1766ab994152f5f169ec5b167ffff7f2005000000,0x00000030e61a86ad71115af58d3e2ab5280a4423920b5311094403376b563b2fc09e9843240a1d2cf05759689835b13573161887f2c284aece535a39642db5d5bf2588e59ec5b167ffff7f2002000000]'

BTC_NETWORK=1 # 0 = mainnet, 1 = testnet, otherwise = regtest

PACKAGE_ID="0x38ef22b837f7488e9f00aec6bb3a177d404f6a5ea2d0ca07ab7d6a649ad87473"

# Create a new light client
function create_light_client() {
    echo $INIT_HEADERS
    sui client call --function new_light_client --module light_client --package $PACKAGE_ID --gas-budget 100000000 --args $BTC_NETWORK 3878320 $INIT_HEADERS 0
}

# get object SPV
# You can use sui explored for more information
function client_object() {
    LC_ID=$1
    sui client object $LC_ID
}

# Insert a new headers
function insert_headers() {
    echo "We extend a current chain"
    echo $HEADERS_FOR_INSERT
    LC_ID=$1
    sui client call --function insert_headers --module light_client --package $PACKAGE_ID --gas-budget 100000000 --args $LC_ID $HEADERS_FOR_INSERT
}

# Insert a new headers with fork potential
function insert_headers_fork_potential() {
    echo "We insert a list header can create fork"
    echo $HEADERS_FOR_FORK
    LC_ID=$1
    sui client call --function insert_headers --module light_client --package $PACKAGE_ID --gas-budget 100000000 --args $LC_ID $HEADERS_FOR_FORK
}

# Get last block
function latest_block() {
    LC_ID=$1
    sui client call --function latest_block --module light_client --package $PACKAGE_ID --gas-budget 100000000 --args $LC_ID --dev-inspect
}


case "$1" in
    create_lc)
	create_light_client
	;;
    insert_headers)
	insert_headers $2
	;;
    insert_headers_fork)
	insert_headers_fork_potential $2
	;;
    latest_block)
	latest_block $2
	;;
    lc_object)
	client_object $2
	;;
    *)
	echo "Invalid option."
	exit 1
	;;
esac
